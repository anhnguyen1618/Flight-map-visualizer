<html>
<header>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css' rel='stylesheet' />
    <link href="./index.css" rel="stylesheet" />
</header>

<body>
    <div id='map'></div>
    <script src="./captitals.js"></script>
    <script>
        const helsinki = {
            "name": "Helsinki",
            "CapitalLatitude": 60.166666666666664,
            "CapitalLongitude": 24.933333,
        }

        mapboxgl.accessToken = 'pk.eyJ1IjoiYW5obmd1eWVuNjI4MSIsImEiOiJjazdka3VsankxMTZ4M2dyd2NrMmRxdzVwIn0.GX9EDHs7fkf2DqEOaYBMSw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            zoom: 2
        });

        var libraries = {
            type: 'FeatureCollection',
            features: [
                { type: 'Feature', properties: { Name: 'Village Branch', Address: '2185 Versailles Rd' }, geometry: { type: 'Point', coordinates: [-84.548369, 38.047876] } },
                { type: 'Feature', properties: { Name: 'Northside Branch', ADDRESS: '1733 Russell Cave Rd' }, geometry: { type: 'Point', coordinates: [-84.47135, 38.079734] } },
                { type: 'Feature', properties: { Name: 'Central Library', ADDRESS: '140 E Main St' }, geometry: { type: 'Point', coordinates: [-84.496894, 38.045459] } },
                { type: 'Feature', properties: { Name: 'Beaumont Branch', Address: '3080 Fieldstone Way' }, geometry: { type: 'Point', coordinates: [-84.557948, 38.012502] } },
                { type: 'Feature', properties: { Name: 'Tates Creek Branch', Address: '3628 Walden Dr' }, geometry: { type: 'Point', coordinates: [-84.498679, 37.979598] } },
                { type: 'Feature', properties: { Name: 'Eagle Creek Branch', Address: '101 N Eagle Creek Dr' }, geometry: { type: 'Point', coordinates: [-84.442219, 37.999437] } }
            ]
        };

        const captitalDots = {
            type: 'FeatureCollection',
            features: captitals.map(({ CapitalName: name, CapitalLongitude: longitude, CapitalLatitude: latitude, CountryName }) => {

                if (Math.abs(longitude) > 180 || Math.abs(latitude) > 90) {
                    console.log(name, longitude, latitude)
                }
                return {
                    type: 'Feature',
                    properties: {
                        Name: name,
                        Description: `Capital of ${CountryName}`
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [longitude, latitude]
                    }
                }
            })
        }




        const routes = {
            'type': 'FeatureCollection',
            'features': captitals.filter(({ CapitalName }) => CapitalName !== helsinki.name)
                .map(({ CapitalName: name, CapitalLongitude: longitude, CapitalLatitude: latitude }, index) => {
                    return {
                        'type': 'Feature',
                        'id': index,
                        'properties': { origin: name },
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [[helsinki.CapitalLongitude, helsinki.CapitalLatitude], [Number(longitude), Number(latitude)]]
                        }
                    }
                })
        }

        const getLineProperties = (distance) => {
            const LONG_HAUL = 10000;
            const UPPER_MEDIUM_HAUL = 5000;
            const LOWER_MEDIUM_HAUL = 3000;


            if (distance > LONG_HAUL) {
                return { color: '#D84315', lineWidth: 0.5, distance }
            }


            if (distance > UPPER_MEDIUM_HAUL) {
                return { color: '#1A237E', lineWidth: 1, distance }
            }


            if (distance > LOWER_MEDIUM_HAUL) {
                return { color: '#00BFA5', lineWidth: 1.5, distance }
            }

            return { color: '#c41497', lineWidth: 2, distance }
        }

        const lineDistances = routes.features.map(route => {

            var lineDistance = turf.lineDistance(route, 'kilometers');
            var steps = 1000;
            const arc = []

            // Draw an arc between the `origin` & `destination` of the two points
            for (var i = 0; i <= lineDistance; i += lineDistance / steps) {
                var segment = turf.along(route, i, 'kilometers');
                arc.push(segment.geometry.coordinates);
            }
            route.properties = { ...route.properties, ...getLineProperties(lineDistance) }

            const prev = route.geometry.coordinates
            route.geometry.coordinates = arc
        })

        console.log('router', routes)


        map.on('load', function () {
            map.addLayer({
                id: 'capitals',
                type: 'symbol',
                source: {
                    type: 'geojson',
                    data: captitalDots
                },
                layout: {
                    'icon-image': 'airport-11',
                    'icon-allow-overlap': true
                },
                paint: {}
            });

            map.addSource('route', {
                'type': 'geojson',
                'data': routes
            });

            map.addLayer({
                'id': 'route',
                'source': 'route',
                'type': 'line',
                'paint': {
                    'line-width': [
                        'case',
                        ['boolean',
                            ['feature-state', 'hover'],
                            false
                        ],
                        10,
                        ['get', 'lineWidth'],
                    ],
                    'line-opacity': [
                        'case',
                        ['boolean',
                            ['feature-state', 'hover'],
                            false
                        ],
                        0.8,
                        1
                    ],
                    'line-color': ['get', 'color'],
                    //'line-color': '#007cbf'
                },
                'layout': {
                    'line-cap': "round"
                }
            });



            var popup = new mapboxgl.Popup();

            map.on('mouseenter', 'capitals', function (e) {
                var features = e.features
                if (!features.length) {
                    popup.remove();
                    return;
                }
                var feature = features[0];

                popup.setLngLat(feature.geometry.coordinates)
                    .setHTML(`<h3>${feature.properties.Name}</h3> <p> ${feature.properties.Description} </p>`)
                    .addTo(map);

                map.getCanvas().style.cursor = features.length ? 'pointer' : '';
            });


            map.on('mouseleave', 'capitals', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            let hoverId = null;

            map.on('mouseenter', 'route', function (e) {
                console.log(e)
                var features = e.features
                if (!features.length) {
                    popup.remove();
                    return;
                }
                var feature = features[0];
                console.log(feature)
                const destination = 'Helsinki';
                popup.setLngLat([e.lngLat.lng, e.lngLat.lat])
                    .setHTML(`<h3>Distance from ${feature.properties.origin} to ${destination}: </h3> <p> ${feature.properties.distance} km </p>`)
                    .addTo(map);

                hoverId = feature.id;
                map.setFeatureState(
                    { source: 'route', id: hoverId },
                    { hover: true }
                );
            });


            map.on('mouseleave', 'route', function (e) {
                console.log('run realve', hoverId)
                const id = hoverId;

                map.getCanvas().style.cursor = '';
                popup.remove();

                if (id != null) {
                    map.setFeatureState(
                        { source: 'route', id },
                        { hover: false }
                    );
                    hoverId = null;
                }




            });
        });

        console.log(captitals)
    </script>
</body>

</html>
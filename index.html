<html>
<header>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css' rel='stylesheet' />
    <link href="./index.css" rel="stylesheet" />
</header>

<body>
    <div id="menu">
        <input id="light-v10" type="radio" name="rtoggle" value="light" />
        <label for="light">light</label>
        <input id="dark-v10" type="radio" name="rtoggle" value="dark" />
        <label for="dark">dark</label>
    </div>
    <div id='map'></div>

    <script src="./captitals.js"></script>
    <script>





        let originCapital = 'Helsinki';

        let theme = 'light-v10';



        mapboxgl.accessToken = 'pk.eyJ1IjoiYW5obmd1eWVuNjI4MSIsImEiOiJjazdka3VsankxMTZ4M2dyd2NrMmRxdzVwIn0.GX9EDHs7fkf2DqEOaYBMSw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            zoom: 2
        });



        const captitalDots = {
            type: 'FeatureCollection',
            features: captitals.map(({ CapitalName: name, CapitalLongitude: longitude, CapitalLatitude: latitude, CountryName }) => {
                return {
                    type: 'Feature',
                    properties: {
                        Name: name,
                        Description: `Capital of ${CountryName}`
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [longitude, latitude]
                    }
                }
            })
        }

        var layerList = document.getElementById('menu');
        var inputs = layerList.getElementsByTagName('input');

        function switchLayer(layer) {
            var theme = layer.target.id;
            const source = map.getSource('route');

            // Diff failed => force diff to false to rerender the entire map
            map.setStyle('mapbox://styles/mapbox/' + theme, { diff: false });

            const done = new Promise((resolve, reject) => {
                map.on('styledata', function () {
                    resolve("done");
                })
            })

            done.then(() => {
                const data = source._data;
                data.features.forEach(feature => {
                    const { distance } = feature.properties
                    feature.properties = { ...feature.properties, ...getLineProperties(distance, theme) };
                })
                addSourceAndLayers(source._data)
            })
        }

        for (var i = 0; i < inputs.length; i++) {
            inputs[i].onclick = switchLayer;
        }

        const mappings = (function buildIndex() {
            const index = {};
            for (const capital of captitals) {
                index[capital.CapitalName] = capital;
            }
            return index;
        })()


        function computeRoutes(origin) {
            const originInfo = mappings[origin]
            if (!originInfo) {
                return {
                    'type': 'FeatureCollection',
                    'features': []
                }
            }

            return {
                'type': 'FeatureCollection',
                'features': captitals.filter(({ CapitalName }) => CapitalName !== origin)
                    .map(({ CapitalName: name, CapitalLongitude: longitude, CapitalLatitude: latitude }, index) => {
                        return {
                            'type': 'Feature',
                            'id': index,
                            'properties': { origin: name },
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': [[Number(originInfo.CapitalLongitude), Number(originInfo.CapitalLatitude)], [Number(longitude), Number(latitude)]]
                            }
                        }
                    })
            }
        }


        function getLineProperties(distance, theme) {
            const LONG_HAUL = 10000;
            const UPPER_MEDIUM_HAUL = 5000;
            const LOWER_MEDIUM_HAUL = 3000;

            const colors = {
                'LONG_HAUL': {
                    'light-v10': '#D84315',
                    'dark-v10': '#ffab40'
                },
                'UPPER_MEDIUM_HAUL': {
                    'light-v10': '#1A237E',
                    'dark-v10': '#448aff'
                },
                'LOWER_MEDIUM_HAUL': {
                    'light-v10': '#00BFA5',
                    'dark-v10': '#00BFA5'
                },
                'SHORT_HAUL': {
                    'light-v10': '#c41497',
                    'dark-v10': '#c41497'
                }
            }


            if (distance > LONG_HAUL) {
                return { color: colors['LONG_HAUL'][theme], lineWidth: 0.5, distance }
            }


            if (distance > UPPER_MEDIUM_HAUL) {
                return { color: colors['UPPER_MEDIUM_HAUL'][theme], lineWidth: 1, distance }
            }


            if (distance > LOWER_MEDIUM_HAUL) {
                return { color: colors['LOWER_MEDIUM_HAUL'][theme], lineWidth: 1.5, distance }
            }

            return { color: colors['SHORT_HAUL'][theme], lineWidth: 2, distance }
        }

        function computeDistancesAndLines(routes) {
            routes.features.forEach(route => {

                var lineDistance = turf.lineDistance(route, 'kilometers');
                var steps = 1000;
                const arc = []

                // Draw an arc between the `origin` & `destination` of the two points
                for (var i = 0; i <= lineDistance; i += lineDistance / steps) {
                    var segment = turf.along(route, i, 'kilometers');
                    arc.push(segment.geometry.coordinates);
                }
                route.properties = { ...route.properties, ...getLineProperties(lineDistance, theme) }

                const prev = route.geometry.coordinates
                route.geometry.coordinates = arc
            })
        }

        function displayFlightRoutes(origin) {
            const routes = computeRoutes(origin);
            computeDistancesAndLines(routes);
            return routes;
        }

        function replaceOrigin(newOrigin) {
            originCapital = newOrigin;
            const source = map.getSource('route');
            if (source) {
                const e = displayFlightRoutes(originCapital);
                source.setData(e)
            }
        }

        function addSourceAndLayers(routes) {
            map.addLayer({
                id: 'capitals',
                type: 'symbol',
                source: {
                    type: 'geojson',
                    data: captitalDots
                },
                layout: {
                    'icon-image': 'airport-11',
                    'icon-allow-overlap': true
                },
                paint: {}
            });

            map.addSource('route', {
                'type': 'geojson',
                'data': routes
            });

            map.addLayer({
                'id': 'route',
                'source': 'route',
                'type': 'line',
                'paint': {
                    'line-width': [
                        'case',
                        ['boolean',
                            ['feature-state', 'hover'],
                            false
                        ],
                        10,
                        ['get', 'lineWidth'],
                    ],
                    'line-opacity': [
                        'case',
                        ['boolean',
                            ['feature-state', 'hover'],
                            false
                        ],
                        0.8,
                        1
                    ],
                    'line-color': ['get', 'color'],
                    //'line-color': '#007cbf'
                },
                'layout': {
                    'line-cap': "round"
                }
            });
        }


        map.on('load', function () {
            const routes = displayFlightRoutes(originCapital);
            addSourceAndLayers(routes);

            var popup = new mapboxgl.Popup();

            map.on('mouseenter', 'capitals', function (e) {
                var features = e.features
                if (!features.length) {
                    popup.remove();
                    return;
                }
                var feature = features[0];

                popup.setLngLat(feature.geometry.coordinates)
                    .setHTML(`<h3>${feature.properties.Name}</h3> <p> ${feature.properties.Description} </p>`)
                    .addTo(map);

                map.getCanvas().style.cursor = features.length ? 'pointer' : '';

            });

            map.on('click', 'capitals', function (e) {
                var features = e.features
                if (!features.length) {
                    return;
                }
                var feature = features[0];

                map.flyTo({
                    center: feature.geometry.coordinates, speed: 0.2, easing: function (t) {
                        return t;
                    },
                });
                /*map.setFeatureState(
                        { source: 'route', id },
                        { focused: false }
                    );*/
                replaceOrigin(feature.properties.Name)
            });


            map.on('mouseleave', 'capitals', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            let hoverId = null;

            map.on('mouseenter', 'route', function (e) {
                var features = e.features
                if (!features.length) {
                    popup.remove();
                    return;
                }
                var feature = features[0];
                const destination = 'Helsinki';
                popup.setLngLat([e.lngLat.lng, e.lngLat.lat])
                    .setHTML(`<h3>Distance from ${feature.properties.origin} to ${originCapital}: </h3> <p> ${feature.properties.distance} km </p>`)
                    .addTo(map);

                hoverId = feature.id;
                map.setFeatureState(
                    { source: 'route', id: hoverId },
                    { hover: true }
                );
            });


            map.on('mouseleave', 'route', function (e) {
                const id = hoverId;

                map.getCanvas().style.cursor = '';
                popup.remove();

                if (id != null) {
                    map.setFeatureState(
                        { source: 'route', id },
                        { hover: false }
                    );
                    hoverId = null;
                }
            });
        });

    </script>
</body>

</html>